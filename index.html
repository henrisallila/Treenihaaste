<!DOCTYPE html>
<html lang="fi">
<head>
  <meta charset="UTF-8">
  <title>Treenihaaste</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    :root {
      --bg: #0f0f0f;
      --card: #1b1b1b;
      --card-soft: #242424;
      --accent: #4caf50;
      --text: #eaeaea;
      --muted: #9a9a9a;
      --danger: #e57373;
    }

    body {
      margin: 0;
      padding: 20px;
      background: var(--bg);
      color: var(--text);
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
    }

    .container {
      max-width: 520px;
      margin: auto;
    }

    h1 {
      text-align: center;
      margin-bottom: 24px;
    }

    h2 {
      margin: 28px 0 12px;
      color: var(--accent);
      font-size: 18px;
    }

    .day {
      background: var(--card);
      border-radius: 16px;
      padding: 16px;
      margin-bottom: 14px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.4);
      transition: transform 0.15s ease;
      position: relative;
    }

    .day.done .user-stamps {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      pointer-events: none;
    }

    .user-stamp {
      position: absolute;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background-size: cover;
      background-position: center;
      border: 2px solid var(--accent);
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
    }

    .day.today {
      border: 2px solid var(--accent);
      background: linear-gradient(180deg, #1c2b20, var(--card));
    }

    .day.future {
      opacity: 0.45;
    }

    .day.done {
      background: var(--card-soft);
      opacity: 0.75;
    }

    .day-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
      font-weight: bold;
    }

    .badge {
      font-size: 12px;
      padding: 4px 10px;
      border-radius: 999px;
      background: #333;
      color: var(--muted);
    }

    .badge.today {
      background: var(--accent);
      color: #000;
    }

    .exercise {
      margin: 4px 0;
      font-size: 16px;
    }

    .rest {
      font-style: italic;
      color: var(--muted);
    }

    .actions {
      margin-top: 12px;
      display: flex;
      gap: 10px;
    }

    button {
      flex: 1;
      padding: 12px;
      font-size: 15px;
      border-radius: 12px;
      border: none;
      font-weight: bold;
    }

    .do-btn {
      background: var(--accent);
      color: #000;
    }

    .undo-btn {
      background: transparent;
      border: 2px solid var(--danger);
      color: var(--danger);
    }

    button:disabled {
      opacity: 0.5;
    }

    .auth-section {
      text-align: center;
      margin-bottom: 16px;
    }

    .auth-section.auth-loading {
      opacity: 0;
      pointer-events: none;
    }

    #login-form {
      display: flex;
      justify-content: center;
      gap: 8px;
      margin-bottom: 16px;
    }

    .auth-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      padding: 6px 12px;
      border-radius: 6px;
      border: none;
      font-weight: bold;
      cursor: pointer;
      font-size: 12px;
    }

    .google-btn {
      background: #fff;
      color: #333;
    }

    .apple-btn {
      background: #000;
      color: #fff;
      border: 1px solid #333;
    }

    .user-info {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 12px;
      margin-bottom: 16px;
    }

    .user-avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      margin-right: 10px;
    }

    .sync-status {
      font-size: 12px;
      color: var(--muted);
      margin-top: 8px;
    }

    .logout-btn {
      background: transparent;
      border: 1px solid var(--muted);
      color: var(--muted);
      padding: 6px 12px;
      font-size: 12px;
    }

    .complete-btn {
      background: linear-gradient(45deg, #ffd700, #ffed4e);
      color: #000;
      font-weight: bold;
      border: 2px solid #ffd700;
      box-shadow: 0 4px 12px rgba(255, 215, 0, 0.3);
    }

    .certificate-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.9);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .certificate {
      background: linear-gradient(135deg, #fff, #f8f8f8);
      color: #333;
      padding: 40px;
      border-radius: 20px;
      text-align: center;
      max-width: 500px;
      width: 90%;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
      border: 3px solid #ffd700;
    }

    .certificate h2 {
      color: #d4af37;
      font-size: 28px;
      margin-bottom: 20px;
      text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.1);
    }

    .certificate .stats {
      font-size: 18px;
      margin: 20px 0;
      padding: 20px;
      background: #f0f0f0;
      border-radius: 10px;
      border-left: 4px solid #ffd700;
    }

    .certificate .close-btn {
      background: var(--accent);
      color: #000;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      font-weight: bold;
      margin-top: 20px;
      cursor: pointer;
    }

    .nav-tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 20px;
      border-bottom: 2px solid var(--card);
    }

    .nav-tab {
      padding: 12px 16px;
      background: none;
      border: none;
      color: var(--muted);
      cursor: pointer;
      font-size: 16px;
      font-weight: bold;
      border-bottom: 3px solid transparent;
      transition: all 0.2s;
    }

    .nav-tab.active {
      color: var(--accent);
      border-bottom-color: var(--accent);
    }

    .nav-tab:hover {
      color: var(--text);
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    /* Challenge 2 styles */
    .day {
      background: var(--card);
      border-radius: 16px;
      padding: 16px;
      margin-bottom: 14px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.4);
      transition: transform 0.15s ease;
      position: relative;
    }

    .day.today {
      border: 2px solid var(--accent);
      background: linear-gradient(180deg, #1c2b20, var(--card));
    }

    .day.future {
      opacity: 0.45;
    }

    .day.completed {
      background: var(--card-soft);
      opacity: 0.75;
    }

    .day.rest-day {
      opacity: 0.6;
      border-left: 4px solid var(--muted);
    }

    .day.failed {
      background: linear-gradient(180deg, #2b1c1c, var(--card));
      border-left: 4px solid var(--warning);
    }

    .day-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
      font-weight: bold;
    }

    .badge {
      font-size: 12px;
      padding: 4px 10px;
      border-radius: 999px;
      background: #333;
      color: var(--muted);
    }

    .badge.today {
      background: var(--accent);
      color: #000;
    }

    .badge.completed {
      background: var(--accent);
      color: #000;
    }

    .badge.failed {
      background: var(--warning);
      color: #000;
    }

    .badge.rest {
      background: var(--accent-blue);
      color: #fff;
    }

    .exercise {
      margin: 4px 0;
      font-size: 16px;
    }

    .rest-label {
      font-style: italic;
      color: var(--muted);
      font-size: 18px;
    }

    .actions {
      margin-top: 12px;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .success-btn {
      background: var(--accent);
      color: #000;
      flex: 1;
      min-width: 100px;
      padding: 10px 12px;
      font-size: 14px;
      border-radius: 8px;
      border: none;
      font-weight: bold;
      cursor: pointer;
    }

    .fail-btn {
      background: var(--warning);
      color: #000;
      flex: 1;
      min-width: 100px;
      padding: 10px 12px;
      font-size: 14px;
      border-radius: 8px;
      border: none;
      font-weight: bold;
      cursor: pointer;
    }

    .rest-btn {
      background: var(--accent-blue);
      color: #fff;
      flex: 1;
      min-width: 100px;
      padding: 10px 12px;
      font-size: 14px;
      border-radius: 8px;
      border: none;
      font-weight: bold;
      cursor: pointer;
    }

    .undo-btn {
      background: transparent;
      border: 2px solid var(--danger);
      color: var(--danger);
      flex: 1;
      min-width: 100px;
      padding: 10px 12px;
      font-size: 14px;
      border-radius: 8px;
      font-weight: bold;
      cursor: pointer;
    }

    .modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.9);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .modal-content {
      background: var(--card);
      padding: 30px;
      border-radius: 16px;
      max-width: 400px;
      width: 90%;
      border: 2px solid var(--accent);
    }

    .modal-content h3 {
      margin-top: 0;
      color: var(--accent);
      font-size: 20px;
    }

    .input-group {
      margin: 15px 0;
    }

    .input-group label {
      display: block;
      margin-bottom: 5px;
      font-size: 14px;
      color: var(--muted);
    }

    .input-group input {
      width: 100%;
      padding: 10px;
      background: var(--card-soft);
      border: 1px solid var(--muted);
      border-radius: 6px;
      color: var(--text);
      font-size: 16px;
      box-sizing: border-box;
    }

    .modal-actions {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }

    .modal-actions button {
      flex: 1;
    }

    :root {
      --accent-blue: #2196F3;
      --warning: #ff9800;
    }
  </style>
</head>
<body>

<div class="container">



  
  <div class="nav-tabs">
    <button class="nav-tab active" data-tab="current">Nykyinen haaste</button>
    <button class="nav-tab" data-tab="rules">S√§√§nn√∂t</button>
    <button class="nav-tab" data-tab="archive">Vanhat haasteet</button>
  </div>

  <div id="current" class="tab-content active">
    <h2 style="margin-top: 0;">üí™ One-shot haaste</h2>
    
    <!-- Account creation blocked notice -->
    <div id="account-blocked" style="display: none; opacity: 0; transition: opacity 0.2s; text-align: center; padding: 40px 20px; background: var(--card); border-radius: 16px; margin: 20px 0;">
      <div style="font-size: 48px; margin-bottom: 16px;">üö´</div>
      <h3 style="color: var(--danger); margin-bottom: 12px;">Tilin luominen ei ole mahdollista</h3>
      <p style="color: var(--muted); margin-bottom: 20px;">T√§m√§ sovellus on suljettu uusilta k√§ytt√§jilt√§. Jos t√§m√§ on mielest√§si virhe, tied√§t keneen olla yhteydess√§.</p>
    </div>
    
    <!-- Login required notice -->
    <div id="login-required" style="display: none; opacity: 0; transition: opacity 0.2s; text-align: center; padding: 40px 20px; background: var(--card); border-radius: 16px; margin: 20px 0;">
      <div style="font-size: 48px; margin-bottom: 16px;">üîí</div>
      <h3 style="color: var(--accent); margin-bottom: 12px;">Kirjautuminen vaaditaan</h3>
      <p style="color: var(--muted); margin-bottom: 20px;">Sinun t√§ytyy kirjautua sis√§√§n aloittaaksesi One-shot haasteen. Kirjautumalla varmistat ett√§ edistymisesi tallennetaan turvallisesti pilveen.</p>
      <button id="login-required-btn" onclick="openAuthSection()" style="padding: 12px 24px; background: var(--accent); color: #000; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 16px;">
        Kirjaudu sis√§√§n
      </button>
      <div id="auth-section" class="auth-section auth-loading" style="display: none; margin-top: 16px;">
        <p id="login-instruction" style="margin: 8px 0; color: var(--muted); font-size: 14px;">Huom! Kaikki muut kirjautuneet k√§ytt√§j√§t n√§kev√§t, nimesi, profiilikuvasi ja tekem√§si treenit. Kirjautumalla hyv√§ksyt tietojen tallentamisen, ja profiilikuvasi n√§kymisen muille k√§ytt√§jille.</p>
        <div id="login-form">
          <button id="google-login" class="auth-btn google-btn">
            Google tili
          </button>
          <button id="email-login" class="auth-btn">
            Muu s√§hk√∂posti
          </button>
        </div>

        <div id="email-form" style="display: none; margin-bottom: 16px;">
          <input type="email" id="email" placeholder="S√§hk√∂posti" style="width: 100%; padding: 8px; margin-bottom: 8px; border-radius: 6px; border: 1px solid var(--muted); background: var(--card); color: var(--text);">
          <input type="password" id="password" placeholder="Salasana" style="width: 100%; padding: 8px; margin-bottom: 8px; border-radius: 6px; border: 1px solid var(--muted); background: var(--card); color: var(--text);">
          <div style="display: flex; gap: 8px;">
            <button id="signin-btn" class="auth-btn" style="background: var(--accent); color: #000; flex: 1;">Kirjaudu</button>
            <button id="signup-btn" class="auth-btn" style="background: transparent; border: 1px solid var(--accent); color: var(--accent); flex: 1; opacity: 0.5; cursor: not-allowed;" disabled>Rekister√∂idy</button>
          </div>
          <div style="font-size: 12px; color: var(--muted); text-align: center; margin-top: 8px;">Uusien k√§ytt√§jien rekister√∂inti ei ole t√§ll√§ hetkell√§ k√§yt√∂ss√§</div>
        </div>

      </div>
    </div>

    <div id="user-info" class="user-info" style="display: none;">
      <img id="user-avatar" class="user-avatar" src="" alt="">
      <div id="user-name"></div>
      <button id="logout" class="logout-btn">Kirjaudu ulos</button>
    </div>
    
    <div id="challenge2-list"></div>

    <!-- Fail Modal -->
    <div id="fail-modal" class="modal" style="display: none;">
      <div class="modal-content">
        <h3>Kuinka monta harjoitetta sait tehty√§?</h3>
        <div class="input-group">
          <label>Punnerrukset (kpl):</label>
          <input type="number" id="fail-pushups" min="0" placeholder="0">
        </div>
        <div class="input-group">
          <label>Vatsalihakset (kpl):</label>
          <input type="number" id="fail-situps" min="0" placeholder="0">
        </div>
        <div class="modal-actions">
          <button class="fail-btn" onclick="submitChallenge2Fail()">Tallenna tulokset</button>
          <button class="undo-btn" onclick="closeChallenge2Fail()">Peruuta</button>
        </div>
      </div>
    </div>
  </div>

  <div id="rules" class="tab-content">
    <h2 style="margin-top: 0;">üìã One-shot haasteen s√§√§nn√∂t</h2>
    
    <div style="background: var(--card); border-radius: 16px; padding: 20px; margin-bottom: 16px;">
      <h3 style="color: var(--accent); margin-top: 0;">üéØ Tavoite</h3>
      <p style="font-size: 18px; margin: 12px 0;"><strong>Tee 30 punnerrusta ja 50 vatsalihasliikett√§ <u>yhdell√§ kertaa</u> (one-shot)!</strong></p>
      <p>Haaste kasvattaa suoritustasi asteittain. Aloita pienest√§ (7 punnerrusta), kunnes pystyt tekem√§√§n lopulta 30 punnerrusta ja 50 vatsalihasliikett√§ per√§kk√§in yhdess√§ istunnossa. Tempo riippuu sinusta ja kuinka nopeasti kuntosi kehittyy. Se vaatii sitkeytt√§ ja p√§√§tt√§v√§isyytt√§!</p>
    </div>

    <div style="background: var(--card); border-radius: 16px; padding: 20px; margin-bottom: 16px;">
      <h3 style="color: var(--accent); margin-top: 0;">üìÖ Kesto ja rakenne</h3>
      <ul style="margin: 12px 0;">
        <li><strong>Todellinen kesto:</strong> Riippuu sinusta! Voi kest√§√§ muutamasta viikosta useisiin kuukausiin riippuen kunnosta ja lepop√§ivist√§</li>
        <li><strong>Lepop√§iv√§t:</strong> Voit pit√§√§ lepop√§ivi√§ ilman ett√§ putki katkeaa</li>
        <li><strong>Uudelleen yritys:</strong> Ep√§onnistumisen j√§lkeen voit yritt√§√§ uudelleen seuraavana p√§iv√§n√§</li>
        <li><strong>Yksi suoritus per p√§iv√§:</strong> Voit tehd√§ vain yhden suorituksen per p√§iv√§</li>
        <li><strong>P√§ivitt√§inen nousu:</strong> Punnerrukset nousevat tasaisesti 1 per aktiivinen suoritusp√§iv√§</li>
      </ul>
    </div>

    <div style="background: var(--card); border-radius: 16px; padding: 20px; margin-bottom: 16px;">
      <h3 style="color: var(--accent); margin-top: 0;">‚úÖ Suoritus ja ep√§onnistuminen</h3>
      <ul style="margin: 12px 0;">
        <li><strong>Suoritettu:</strong> Merkitse p√§iv√§ onnistuneeksi, kun olet suorittanut vaaditut liikkeet</li>
        <li><strong>Ep√§onnistui:</strong> Jos et saa tehty√§ kaikkea, voit merkit√§ kuinka monta sait aikaan</li>
        <li><strong>Uudelleenyritys:</strong> Voit yritt√§√§ ep√§onnistuneet p√§iv√§t seuraavana p√§iv√§n√§ uudelleen</li>
        <li><strong>Kumoa:</strong> Voit peruuttaa mink√§ tahansa merkinn√§n kumoa-napilla</li>
      </ul>
    </div>

    <div style="background: var(--card); border-radius: 16px; padding: 20px; margin-bottom: 16px;">
      <h3 style="color: var(--accent); margin-top: 0;">üî• Putki ja motivaatio</h3>
      <ul style="margin: 12px 0;">
        <li><strong>Putki:</strong> N√§et kuinka moneen p√§iv√§√§n olet onnistunut per√§kk√§in</li>
        <li><strong>Lepop√§iv√§t:</strong> Putki jatkuu vaikka pit√§isit tauon, mutta ep√§onnistuminen katkaisee sen</li>
        <li><strong>Lepomuistutus:</strong> Jos olet treenannut 3+ p√§iv√§√§ per√§kk√§in, saat muistutuksen levosta (putki ei katkea)</li>
        <li><strong>Palaa takaisin -viesti:</strong> Jos olet pit√§nyt yli 3 lepop√§iv√§√§, n√§et motivoivan viestin kun avaat sovelluksen</li>
        <li><strong>Huom:</strong> Viestit n√§kyv√§t vain kun avaat sivun - emme l√§het√§ oikeita push-ilmoituksia puhelimeen</li>
      </ul>
    </div>

    <div style="background: var(--card); border-radius: 16px; padding: 20px; margin-bottom: 16px;">
      <h3 style="color: var(--accent); margin-top: 0;">üåê Yhteis√∂ ja n√§kyvyys</h3>
      <ul style="margin: 12px 0;">
        <li><strong>Profiili:</strong> Kun kirjaudut sis√§√§n, muut k√§ytt√§j√§t n√§kev√§t nimesi ja profiilikuvasi</li>
        <li><strong>Suorittajat:</strong> N√§et ketk√§ muut ovat suorittaneet saman p√§iv√§n</li>
        <li><strong>Kannustus:</strong> Ole osa yhteis√∂√§ ja inspiroi muita suoriutumalla!</li>
      </ul>
    </div>

    <div style="background: linear-gradient(135deg, #1c2b20, var(--card)); border-radius: 16px; padding: 20px; border: 2px solid var(--accent);">
      <h3 style="color: var(--accent); margin-top: 0;">üí™ Aloita haaste nyt!</h3>
      <p>Klikkaa "Nykyinen haaste" -v√§lilehte√§ aloittaaksesi. Haaste kasvattaa kuntosi asteittain - aloitat kevyesti ja joka p√§iv√§ teet v√§h√§n enemm√§n. Lopulta pystyt tekem√§√§n 30 punnerrusta ja 50 vatsalihasliikett√§ yhdell√§ suorituksella!</p>
      <p style="margin-top: 12px;"><strong>Ota haaste vastaan ja ylit√§ itsesi!</strong> üî•</p>
    </div>
  </div>

  <div id="archive" class="tab-content">
    <h2 style="margin-top: 0;">3 viikon treenihaaste</h2>
    <div id="list"></div>
  </div>
  
  <!-- Certificate Modal -->
  <div id="certificate-modal" class="certificate-modal" style="display: none;">
    <div class="certificate">
      <h2>üèÜ ONNITTELUT! üèÜ</h2>
      <p><strong>Olet suorittanut 3 viikon treenihaasteesi!</strong></p>
      <div class="stats" id="certificate-stats">
        <!-- Stats will be populated here -->
      </div>
      <p>Hienoa ty√∂t√§! Olet osoittanut sitkeytt√§ ja p√§√§tt√§v√§isyytt√§.</p>
      <div style="display: flex; gap: 10px; justify-content: center;">
        <button class="close-btn" onclick="downloadImage()">üñºÔ∏è Lataa kuva</button>
        <button class="close-btn" onclick="closeCertificate()">Sulje</button>
      </div>
    </div>
  </div>
</div>

<script type="module">
  import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
  import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
  import { getFirestore, doc, setDoc, getDoc, onSnapshot, collection, getDocs, query, where, deleteDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

  // Firebase config - n√§m√§ voivat n√§ky√§ julkisesti
  // Turvallisuus tulee Firebase Security Rules -s√§√§nn√∂ist√§
  const firebaseConfig = {
    apiKey: "AIzaSyCTXfIiaTS1H3nFTZSWbGvx0kcOf3Lmwek",
    authDomain: "treenihaaste-15c92.firebaseapp.com",
    projectId: "treenihaaste-15c92",
    storageBucket: "treenihaaste-15c92.firebasestorage.app",
    messagingSenderId: "1031392742682",
    appId: "1:1031392742682:web:274b1d8500ee3bb25370a3"
  };

  // Tarkista onko Firebase konfiguroitu
  const isFirebaseConfigured = firebaseConfig.apiKey !== "AIzaSyBexample-replace-with-your-key";
  
  let app, auth, db;
  if (isFirebaseConfigured) {
    app = initializeApp(firebaseConfig);
    auth = getAuth(app);
    db = getFirestore(app);
  }
  
  let currentUser = null;
  let unsubscribe = null;
  let progressCache = null;
  let lastCacheTime = 0;
  const CACHE_DURATION = 30000; // 30 seconds

  const startDate = new Date("2026-01-08");
  const MS_PER_DAY = 1000 * 60 * 60 * 24;

  const plan = [
    { p: 5, a: 10 }, { p: 6, a: 12 }, null,
    { p: 7, a: 15 }, { p: 8, a: 18 }, null,
    { p: 9, a: 20 },

    { p: 10, a: 22 }, { p: 12, a: 25 }, null,
    { p: 14, a: 28 }, { p: 16, a: 32 }, null,
    { p: 18, a: 35 },

    { p: 20, a: 38 }, { p: 22, a: 42 }, null,
    { p: 25, a: 45 }, { p: 28, a: 50 }, null,
    { p: 30, a: 60 }
  ];

  const todayIndex = Math.floor((new Date() - startDate) / MS_PER_DAY);
  const list = document.getElementById("list");

  function weekForDay(i) {
    return Math.floor(i / 7) + 1;
  }

  function getEmailFirstName(email) {
    if (!email) return '';
    const localPart = email.split('@')[0] || '';
    if (!localPart) return '';
    const base = localPart.split('+')[0];
    const parts = base.split('.').filter(Boolean);
    const clean = (value) => value.replace(/[^a-zA-Z√Ö√Ñ√ñ√•√§√∂]/g, '');
    const candidates = (parts.length ? parts : [base])
      .map(clean)
      .filter((value) => value.length >= 3);

    if (candidates.length === 0) {
      const cleaned = clean(base);
      return cleaned.length >= 3 ? cleaned : '';
    }

    let shortest = candidates[0];
    candidates.forEach((value) => {
      if (value.length < shortest.length) shortest = value;
    });
    return shortest;
  }

  function getUserFirstName(user) {
    if (!user) return 'K√§ytt√§j√§';
    const displayName = (user.displayName || '').trim();
    if (displayName) {
      const firstName = displayName.split(/\s+/)[0];
      if (firstName) return firstName;
    }

    const emailName = getEmailFirstName(user.email || '');
    if (emailName) return emailName.charAt(0).toUpperCase() + emailName.slice(1);
    return 'K√§ytt√§j√§';
  }

  function getInitialAvatar(name) {
    const trimmed = (name || '').trim();
    const letter = trimmed ? trimmed.charAt(0).toUpperCase() : 'üë§';
    const svg = `<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 32 32"><circle cx="16" cy="16" r="16" fill="#007acc"/><text x="16" y="20" text-anchor="middle" fill="white" font-size="14">${letter}</text></svg>`;
    return `data:image/svg+xml;utf8,${encodeURIComponent(svg)}`;
  }

  function getStoredNameFirstName(name) {
    const trimmed = (name || '').trim();
    if (!trimmed) return 'K√§ytt√§j√§';
    if (trimmed.includes('@')) {
      const emailName = getEmailFirstName(trimmed);
      if (emailName) return emailName.charAt(0).toUpperCase() + emailName.slice(1);
    }
    return trimmed.split(/\s+/)[0] || 'K√§ytt√§j√§';
  }

  function normalizeAvatar(avatarUrl, name) {
    if (!avatarUrl) return getInitialAvatar(name);
    if (avatarUrl.startsWith('data:image/svg+xml;base64') || avatarUrl.startsWith('data:image/svg+xml;utf8')) {
      return getInitialAvatar(name);
    }
    return avatarUrl;
  }

  async function saveProgress(dayIndex, completed) {
    if (currentUser && isFirebaseConfigured) {
      try {
        const completionDoc = doc(db, 'completions', `${currentUser.uid}_day-${dayIndex}`);
        if (completed) {
          await setDoc(completionDoc, {
            userId: currentUser.uid,
            dayIndex,
            avatar: currentUser.photoURL || getInitialAvatar(getUserFirstName(currentUser)),
            name: getUserFirstName(currentUser),
            timestamp: new Date()
          });
        } else {
          await setDoc(completionDoc, { deleted: true });
        }
        progressCache = null; // Clear cache
      } catch (error) {
        console.error('Sync error:', error);
      }
    } else {
      if (completed) {
        localStorage.setItem(`done-day-${dayIndex}`, JSON.stringify({
          completed: true,
          userAvatar: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 32 32"><circle cx="16" cy="16" r="16" fill="%234caf50"/><text x="16" y="20" text-anchor="middle" fill="white" font-size="12">‚úì</text></svg>'
        }));
      } else {
        localStorage.removeItem(`done-day-${dayIndex}`);
      }
    }
  }

  async function getProgress() {
    if (currentUser && isFirebaseConfigured) {
      // Use cache if recent
      const now = Date.now();
      if (progressCache && (now - lastCacheTime) < CACHE_DURATION) {
        return progressCache;
      }

      try {
        const completionsRef = collection(db, 'completions');
        const querySnapshot = await getDocs(completionsRef);
        
        const progress = {};
        querySnapshot.forEach((doc) => {
          const data = doc.data();
          if (!data.deleted) {
            const dayKey = `day-${data.dayIndex}`;
            if (!progress[dayKey]) progress[dayKey] = {};
            progress[dayKey][data.userId] = {
              avatar: normalizeAvatar(data.avatar, getStoredNameFirstName(data.name)),
              name: data.name
            };
          }
        });
        
        progressCache = progress;
        lastCacheTime = now;
        return progress;
      } catch (error) {
        console.error('Load error:', error);
        return progressCache || {};
      }
    } else {
      const progress = {};
      plan.forEach((_, i) => {
        const stored = localStorage.getItem(`done-day-${i}`);
        if (stored) {
          try {
            const data = JSON.parse(stored);
            progress[`day-${i}`] = { 'local': data };
          } catch {
            progress[`day-${i}`] = { 'local': { completed: true, userAvatar: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 32 32"><circle cx="16" cy="16" r="16" fill="%234caf50"/><text x="16" y="20" text-anchor="middle" fill="white" font-size="12">‚úì</text></svg>' } };
          }
        }
      });
      return progress;
    }
  }

  async function complete(i) {
    await saveProgress(i, true);
    render();
  }

  async function undo(i) {
    await saveProgress(i, false);
    render();
  }

  async function render() {
    const progress = await getProgress();
    const now = new Date();
    // K√§yt√§ Suomen aikaa (UTC+2/+3)
    const finlandTime = new Date(now.getTime() + (2 * 60 * 60 * 1000)); // UTC+2 (talvi)
    const todayIndex = Math.floor((finlandTime - startDate) / MS_PER_DAY);
    
    // Debug info
    console.log('UTC time:', now.toISOString());
    console.log('Finland time:', finlandTime.toISOString());
    console.log('Today index:', todayIndex);
    
    list.innerHTML = "";
    let currentWeek = 0;

    plan.forEach((day, i) => {
      const week = weekForDay(i);
      if (week !== currentWeek) {
        currentWeek = week;
        const h = document.createElement("h2");
        h.textContent = `Viikko ${week}`;
        list.appendChild(h);
      }

      const div = document.createElement("div");
      div.className = "day";

      const dayUsers = progress[`day-${i}`] || {};
      const userCount = Object.keys(dayUsers).length;
      const isToday = i === todayIndex;
      const isFuture = i > todayIndex;
      const currentUserDone = currentUser && dayUsers[currentUser.uid];
      const localUserDone = !currentUser && dayUsers['local'];
      const isLastDay = i === plan.length - 1;
      const isCompleted = currentUserDone || localUserDone;

      if (isToday) div.classList.add("today");
      if (isFuture) div.classList.add("future");
      if (userCount > 0) div.classList.add("done");

      let badge = "";
      if (isToday) badge = `<span class="badge today">T√ÑN√Ñ√ÑN</span>`;
      else if (userCount > 0) badge = `<span class="badge">SUORITTAJAT (${userCount})</span>`;
      else badge = `<span class="badge">P√§iv√§ ${i + 1}</span>`;

      let html = `
        <div class="day-header">
          <div>P√§iv√§ ${i + 1}</div>
          ${badge}
        </div>
      `;

      if (day === null) {
        html += `<div class="rest">üò¥ Lepop√§iv√§</div>`;
      } else {
        html += `
          <div class="exercise">Punnerrukset: <strong>${day.p}</strong></div>
          <div class="exercise">Vatsat: <strong>${day.a}</strong></div>
        `;

        if (!isFuture) {
          html += `<div class="actions">`;

          if (!isCompleted && isToday) {
            html += `<button class="do-btn" onclick="complete(${i})">SUORITA!</button>`;
          }

          if (isCompleted && isToday) {
            html += `<button class="undo-btn" onclick="undo(${i})">POISTA SUORITUS</button>`;
          }

          // Add completion button for last day
          if (isLastDay && !isFuture) {
            html += `<button class="complete-btn" onclick="showCertificate()">üèÜ HAASTE VALMIS!</button>`;
          }

          html += `</div>`;
        }
      }

      // Add user stamps (only when logged in)
      if (currentUser && userCount > 0) {
        html += `<div class="user-stamps">`;
        const positions = [
          { top: '30%', left: '25%' },
          { top: '40%', right: '30%' },
          { top: '50%', right: '15%' },
          { top: '25%', right: '25%' },
          { bottom: '30%', right: '20%' },
          { top: '35%', left: '30%' }
        ];
        
        // Sekoita positiot p√§iv√§kohtaisesti
        const dayRandom = new Array(positions.length).fill().map((_, idx) => idx);
        for (let j = dayRandom.length - 1; j > 0; j--) {
          const k = Math.floor(((i + 1) * 9301 + 49297) % 233280) % (j + 1);
          [dayRandom[j], dayRandom[k]] = [dayRandom[k], dayRandom[j]];
        }
        
        Object.values(dayUsers).forEach((user, index) => {
          const pos = positions[dayRandom[index % positions.length]];
          const rotation = Math.floor(((i + index) * 7919 + 31337) % 21) - 10;
          const style = Object.entries(pos).map(([key, value]) => `${key}: ${value}`).join('; ') + `; transform: rotate(${rotation}deg)`;
          const userName = getStoredNameFirstName(user.name);
          const avatar = normalizeAvatar(user.avatar || user.userAvatar, userName);
          html += `<div class="user-stamp" style="${style}; background-image: url(${avatar})"></div>`;
        });
        html += `</div>`;
      }

      div.innerHTML = html;
      list.appendChild(div);
    });
  }

  // Auth functions
  async function signInWithGoogle() {
    if (!isFirebaseConfigured) return;
    try {
      const provider = new GoogleAuthProvider();
      await signInWithPopup(auth, provider);
    } catch (error) {
      console.error('Google sign in error:', error);
    }
  }

  async function signInWithEmail() {
    if (!isFirebaseConfigured) return;
    const email = document.getElementById('email').value;
    const password = document.getElementById('password').value;
    try {
      await signInWithEmailAndPassword(auth, email, password);
    } catch (error) {
      console.error('Email sign in error:', error);
      alert('Kirjautuminen ep√§onnistui: ' + error.message);
    }
  }

  async function signUpWithEmail() {
    alert('Uusien k√§ytt√§jien rekister√∂inti ei ole t√§ll√§ hetkell√§ k√§yt√∂ss√§.');
  }

  async function handleSignOut() {
    if (!isFirebaseConfigured) return;
    try {
      await signOut(auth);
    } catch (error) {
      console.error('Sign out error:', error);
    }
  }

  function openAuthSection() {
    const authSection = document.getElementById('auth-section');
    const loginForm = document.getElementById('login-form');
    const emailForm = document.getElementById('email-form');
    const loginInstruction = document.getElementById('login-instruction');
    const accountBlocked = document.getElementById('account-blocked');
    const loginRequired = document.getElementById('login-required');
    const loginRequiredBtn = document.getElementById('login-required-btn');

    if (accountBlocked) {
      accountBlocked.style.display = 'none';
      accountBlocked.style.opacity = '0';
    }

    if (loginRequired) {
      loginRequired.style.display = 'block';
      loginRequired.style.opacity = '1';
    }
    if (loginRequiredBtn) loginRequiredBtn.style.display = 'none';

    if (authSection) authSection.style.display = 'block';
    if (loginForm) loginForm.style.display = 'flex';
    if (emailForm) emailForm.style.display = 'none';
    if (loginInstruction) loginInstruction.style.display = 'block';
  }

  function updateAuthUI(user) {
    const authSection = document.getElementById('auth-section');
    const loginForm = document.getElementById('login-form');
    const emailForm = document.getElementById('email-form');
    const userInfo = document.getElementById('user-info');
    const loginInstruction = document.getElementById('login-instruction');
    const loginRequiredBtn = document.getElementById('login-required-btn');
    
    // Poistetaan loading-tila kun autentikaatio on tarkistettu
    authSection.classList.remove('auth-loading');
    
    if (!isFirebaseConfigured) {
      authSection.style.display = 'none';
      return;
    }
    
    if (user) {
      authSection.style.display = 'block';
      loginForm.style.display = 'none';
      emailForm.style.display = 'none';
      userInfo.style.display = 'flex';
      loginInstruction.style.display = 'none';
      if (loginRequiredBtn) loginRequiredBtn.style.display = 'none';
      document.getElementById('user-name').textContent = getUserFirstName(user);
      document.getElementById('user-avatar').src = user.photoURL || 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 32 32"><circle cx="16" cy="16" r="16" fill="%23666"/><text x="16" y="20" text-anchor="middle" fill="white" font-size="14">üë§</text></svg>';
    } else {
      authSection.style.display = 'none';
      loginForm.style.display = 'flex';
      emailForm.style.display = 'none';
      userInfo.style.display = 'none';
      loginInstruction.style.display = 'block';
      if (loginRequiredBtn) loginRequiredBtn.style.display = 'inline-block';
    }
  }

  // Show email form
  document.getElementById('email-login').addEventListener('click', () => {
    document.getElementById('login-form').style.display = 'none';
    document.getElementById('email-form').style.display = 'block';
  });

  // Event listeners
  document.getElementById('google-login').addEventListener('click', signInWithGoogle);
  document.getElementById('signin-btn').addEventListener('click', signInWithEmail);
  document.getElementById('signup-btn').addEventListener('click', signUpWithEmail);
  document.getElementById('logout').addEventListener('click', handleSignOut);

  // Auth state listener
  if (isFirebaseConfigured) {
    onAuthStateChanged(auth, async (user) => {
      console.log('=== onAuthStateChanged triggered ===', user ? user.email : 'null');
      currentUser = user;
      
      // Check if user was created on or after Feb 1, 2026
      if (user) {
        try {
          console.log('User metadata:', user.metadata);
          const userCreationTime = new Date(user.metadata.creationTime);
          console.log('User creation time:', userCreationTime, 'ISO:', userCreationTime.toISOString());
          
          // Compare by date only (year, month, day)
          const creationYear = userCreationTime.getUTCFullYear();
          const creationMonth = userCreationTime.getUTCMonth();
          const creationDay = userCreationTime.getUTCDate();
          
          // Feb 1, 2026
          const cutoffYear = 2026;
          const cutoffMonth = 1; // 0 = January, 1 = February
          const cutoffDay = 1;
          
          console.log(`Created: ${creationYear}-${String(creationMonth).padStart(2,'0')}-${String(creationDay).padStart(2,'0')}, Cutoff: ${cutoffYear}-${String(cutoffMonth).padStart(2,'0')}-${String(cutoffDay).padStart(2,'0')}`);
          
          const isCreatedOnOrAfterCutoff = 
            creationYear > cutoffYear ||
            (creationYear === cutoffYear && creationMonth > cutoffMonth) ||
            (creationYear === cutoffYear && creationMonth === cutoffMonth && creationDay >= cutoffDay);
          
          console.log('Is too new (>= Feb 1):', isCreatedOnOrAfterCutoff);
          
          if (isCreatedOnOrAfterCutoff) {
            // User is too new, log them out
            console.log('>>> BLOCKING NEW USER <<<');
            await signOut(auth);
            currentUser = null;
            
            // Show blocked message
            const blockedDiv = document.getElementById('account-blocked');
            const loginRequiredDiv = document.getElementById('login-required');
            const challenge2List = document.getElementById('challenge2-list');
            
            if (blockedDiv) {
              blockedDiv.style.display = 'block';
              blockedDiv.style.opacity = '1';
            }
            if (loginRequiredDiv) loginRequiredDiv.style.display = 'none';
            if (challenge2List) challenge2List.style.display = 'none';
            
            updateAuthUI(null);
            return;
          }
        } catch (error) {
          console.error('Error checking user creation date:', error);
        }
      }
      
      updateAuthUI(user);
      
      if (unsubscribe) unsubscribe();
      
      if (user) {
        // Sync local data to cloud on first login
        plan.forEach(async (_, i) => {
          const stored = localStorage.getItem(`done-day-${i}`);
          if (stored) {
            try {
              const data = JSON.parse(stored);
              if (data.completed) {
                const completionDoc = doc(db, 'completions', `${user.uid}_day-${i}`);
                await setDoc(completionDoc, {
                  userId: user.uid,
                  dayIndex: i,
                  avatar: user.photoURL || getInitialAvatar(getUserFirstName(user)),
                  name: getUserFirstName(user),
                  timestamp: new Date()
                });
              }
            } catch (error) {
              console.error('Sync error for day', i, error);
            }
          }
        });
        
        // Sync challenge2 local data to cloud
        challenge2Plan.forEach(async (_, i) => {
          const stored = localStorage.getItem(`challenge2-day-${i}`);
          if (stored) {
            try {
              const data = JSON.parse(stored);
              const completionDoc = doc(db, 'challenge2', `${user.uid}_day-${i}`);
              await setDoc(completionDoc, {
                userId: user.uid,
                dayIndex: i,
                status: data.status,
                pushups: data.pushups || 0,
                situps: data.situps || 0,
                avatar: user.photoURL || getInitialAvatar(getUserFirstName(user)),
                name: getUserFirstName(user),
                timestamp: new Date()
              });
            } catch (error) {
              console.error('Challenge2 sync error for day', i, error);
            }
          }
        });
        
        progressCache = null; // Clear cache after sync
        challenge2ProgressCache = null; // Clear challenge2 cache
        
        // Listen for real-time updates
        const userDoc = doc(db, 'users', user.uid);
        unsubscribe = onSnapshot(userDoc, (doc) => {
          render();
          challenge2Render();
        });
      }
      
      render();
      challenge2Render();
    });
  } else {
    updateAuthUI(null);
    render();
    // Don't render challenge2 if Firebase not configured - will show login screen
    if (isFirebaseConfigured) {
      challenge2Render();
    }
  }

  // Make functions global for onclick handlers
  window.complete = complete;
  window.undo = undo;
  window.openAuthSection = openAuthSection;
  
  // Certificate functions
  async function showCertificate() {
    const progress = await getProgress();
    let totalPushups = 0;
    let totalSitups = 0;
    let completedDays = 0;
    
    plan.forEach((day, i) => {
      if (day !== null) {
        const dayUsers = progress[`day-${i}`] || {};
        const currentUserDone = currentUser && dayUsers[currentUser.uid];
        const localUserDone = !currentUser && dayUsers['local'];
        
        if (currentUserDone || localUserDone) {
          totalPushups += day.p;
          totalSitups += day.a;
          completedDays++;
        }
      }
    });
    
    const userName = getUserFirstName(currentUser);
    
    const statsHtml = `
      <div><strong>Suoritetut p√§iv√§t:</strong> ${completedDays} / 15</div>
      <div><strong>Punnerrukset yhteens√§:</strong> ${totalPushups} kpl</div>
      <div><strong>Vatsalihakset yhteens√§:</strong> ${totalSitups} kpl</div>
      <div><strong>Liikkeit√§ yhteens√§:</strong> ${totalPushups + totalSitups} kpl</div>
    `;
    
    document.getElementById('certificate-stats').innerHTML = statsHtml;
    document.querySelector('.certificate h2').textContent = `üèÜ KUNNIAKIRJA üèÜ`;
    document.querySelector('.certificate p').innerHTML = `<strong>${userName} on suorittanut 3 viikon treenihaasteen!</strong>`;
    document.getElementById('certificate-modal').style.display = 'flex';
  }
  
  function closeCertificate() {
    document.getElementById('certificate-modal').style.display = 'none';
  }
  
  async function downloadImage() {
    const progress = await getProgress();
    let totalPushups = 0;
    let totalSitups = 0;
    let completedDays = 0;
    
    plan.forEach((day, i) => {
      if (day !== null) {
        const dayUsers = progress[`day-${i}`] || {};
        const currentUserDone = currentUser && dayUsers[currentUser.uid];
        const localUserDone = !currentUser && dayUsers['local'];
        
        if (currentUserDone || localUserDone) {
          totalPushups += day.p;
          totalSitups += day.a;
          completedDays++;
        }
      }
    });
    
    const userName = getUserFirstName(currentUser);
    
    // Create canvas
    const canvas = document.createElement('canvas');
    canvas.width = 800;
    canvas.height = 600;
    const ctx = canvas.getContext('2d');
    
    // Background
    ctx.fillStyle = '#f8f8f8';
    ctx.fillRect(0, 0, 800, 600);
    
    // Border
    ctx.strokeStyle = '#ffd700';
    ctx.lineWidth = 8;
    ctx.strokeRect(20, 20, 760, 560);
    
    // Title
    ctx.fillStyle = '#d4af37';
    ctx.font = 'bold 48px Arial';
    ctx.textAlign = 'center';
    ctx.fillText('üèÜ KUNNIAKIRJA üèÜ', 400, 100);
    
    // Main text
    ctx.fillStyle = '#333';
    ctx.font = 'bold 32px Arial';
    ctx.fillText(`${userName} on suorittanut`, 400, 180);
    ctx.fillText('3 viikon treenihaasteen!', 400, 220);
    
    // Stats
    ctx.font = '24px Arial';
    ctx.fillText(`Suoritetut p√§iv√§t: ${completedDays} / 15`, 400, 300);
    ctx.fillText(`Punnerrukset yhteens√§: ${totalPushups} kpl`, 400, 340);
    ctx.fillText(`Vatsalihakset yhteens√§: ${totalSitups} kpl`, 400, 380);
    ctx.fillText(`Liikkeit√§ yhteens√§: ${totalPushups + totalSitups} kpl`, 400, 420);
    
    // Footer
    ctx.font = '18px Arial';
    ctx.fillText('Hienoa ty√∂t√§! Olet osoittanut sitkeytt√§ ja p√§√§tt√§v√§isyytt√§.', 400, 480);
    ctx.fillText(`P√§iv√§m√§√§r√§: ${new Date().toLocaleDateString('fi-FI')}`, 400, 520);
    
    // Download
    const link = document.createElement('a');
    link.download = `treenihaaste-kunniakirja-${userName.replace(/[^a-zA-Z0-9]/g, '_')}.png`;
    link.href = canvas.toDataURL();
    link.click();
  }
  
  window.showCertificate = showCertificate;
  window.closeCertificate = closeCertificate;
  window.downloadImage = downloadImage;

  // ===== CHALLENGE 2 =====
  const challenge2Plan = [
    // Viikko 1 - Alku 7 punnerrusta ja 10 vatsalihasliikett√§
    { p: 7, a: 10 }, { p: 8, a: 12 }, { p: 9, a: 14 }, { p: 10, a: 15 },
    // Viikko 2
    { p: 11, a: 17 }, { p: 12, a: 19 }, { p: 13, a: 20 }, { p: 14, a: 22 },
    // Viikko 3
    { p: 15, a: 24 }, { p: 16, a: 25 }, { p: 17, a: 27 }, { p: 18, a: 29 },
    // Viikko 4
    { p: 19, a: 30 }, { p: 20, a: 32 }, { p: 21, a: 34 }, { p: 22, a: 35 },
    // Viikko 5
    { p: 23, a: 37 }, { p: 24, a: 39 }, { p: 25, a: 40 }, { p: 26, a: 42 },
    // Viikko 6 - Loppu 30 punnerrusta ja 50 vatsaa
    { p: 27, a: 44 }, { p: 28, a: 45 }, { p: 29, a: 47 }, { p: 30, a: 50 },
  ];

  const challenge2StartDate = new Date("2026-01-29");
  let challenge2FailingDayIndex = null;
  let challenge2ProgressCache = null;
  let challenge2LastCacheTime = 0;

  function challenge2WeekForDay(i) {
    return Math.floor(i / 4) + 1;
  }

  async function challenge2SaveProgress(dayIndex, status, data = {}) {
    if (currentUser && isFirebaseConfigured) {
      try {
        const completionDoc = doc(db, 'challenge2', `${currentUser.uid}_day-${dayIndex}`);
        await setDoc(completionDoc, {
          userId: currentUser.uid,
          dayIndex,
          status,
          pushups: data.pushups || 0,
          situps: data.situps || 0,
          avatar: currentUser.photoURL || getInitialAvatar(getUserFirstName(currentUser)),
          name: getUserFirstName(currentUser),
          timestamp: new Date()
        });
        challenge2ProgressCache = null;
      } catch (error) {
        console.error('Challenge2 Save error:', error);
      }
    } else {
      localStorage.setItem(`challenge2-day-${dayIndex}`, JSON.stringify({
        status,
        pushups: data.pushups || 0,
        situps: data.situps || 0,
        timestamp: new Date().toISOString(),
        userAvatar: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 32 32"><circle cx="16" cy="16" r="16" fill="%234caf50"/><text x="16" y="20" text-anchor="middle" fill="white" font-size="12">‚úì</text></svg>'
      }));
    }
  }

  async function challenge2GetProgress() {
    if (currentUser && isFirebaseConfigured) {
      const now = Date.now();
      if (challenge2ProgressCache && (now - challenge2LastCacheTime) < CACHE_DURATION) {
        return challenge2ProgressCache;
      }

      try {
        const completionsRef = collection(db, 'challenge2');
        const querySnapshot = await getDocs(completionsRef);
        
        const progress = {};
        querySnapshot.forEach((docSnapshot) => {
          const data = docSnapshot.data();
          if (data.deleted) return;
          const dayKey = `day-${data.dayIndex}`;
          if (!progress[dayKey]) progress[dayKey] = {};
          progress[dayKey][data.userId] = {
            status: data.status,
            pushups: data.pushups || 0,
            situps: data.situps || 0,
            avatar: normalizeAvatar(data.avatar, getStoredNameFirstName(data.name)),
            name: data.name,
            timestamp: data.timestamp
          };
        });
        
        challenge2ProgressCache = progress;
        challenge2LastCacheTime = now;
        return progress;
      } catch (error) {
        console.error('Challenge2 Load error:', error);
        return challenge2ProgressCache || {};
      }
    } else {
      const progress = {};
      challenge2Plan.forEach((_, i) => {
        const stored = localStorage.getItem(`challenge2-day-${i}`);
        if (stored) {
          try {
            const data = JSON.parse(stored);
            progress[`day-${i}`] = { 'local': data };
          } catch {}
        }
      });
      return progress;
    }
  }

  function challenge2HasCompletedToday(progress) {
    const now = new Date();
    const finlandTime = new Date(now.getTime() + (2 * 60 * 60 * 1000));
    
    // Calculate today's start and end in UTC based on Finland date
    const todayStart = new Date(Date.UTC(finlandTime.getUTCFullYear(), finlandTime.getUTCMonth(), finlandTime.getUTCDate()) - (2 * 60 * 60 * 1000));
    const todayEnd = new Date(todayStart.getTime() + MS_PER_DAY);
    
    console.log('Checking completions today. Current time:', now.toISOString());
    console.log('Today range (UTC):', todayStart.toISOString(), '-', todayEnd.toISOString());
    
    for (let i = 0; i < challenge2Plan.length; i++) {
      const dayUsers = progress[`day-${i}`] || {};
      const currentUserData = currentUser ? dayUsers[currentUser.uid] : dayUsers['local'];
      
      if (currentUserData && currentUserData.timestamp) {
        const completionDate = currentUserData.timestamp.toDate ? currentUserData.timestamp.toDate() : new Date(currentUserData.timestamp);
        console.log(`Day ${i} completed at:`, completionDate.toISOString());
        if (completionDate >= todayStart && completionDate < todayEnd) {
          console.log('Found completion today!');
          return true;
        }
      }
    }
    console.log('No completions today');
    return false;
  }

  function challenge2IsFailedToday(dayIndex, progress) {
    const dayUsers = progress[`day-${dayIndex}`] || {};
    const currentUserData = currentUser ? dayUsers[currentUser.uid] : dayUsers['local'];
    
    if (!currentUserData || currentUserData.status !== 'failed' || !currentUserData.timestamp) {
      return false;
    }
    
    const now = new Date();
    const finlandTime = new Date(now.getTime() + (2 * 60 * 60 * 1000));
    const todayStart = new Date(Date.UTC(finlandTime.getUTCFullYear(), finlandTime.getUTCMonth(), finlandTime.getUTCDate()) - (2 * 60 * 60 * 1000));
    const todayEnd = new Date(todayStart.getTime() + MS_PER_DAY);
    
    const failDate = currentUserData.timestamp.toDate ? currentUserData.timestamp.toDate() : new Date(currentUserData.timestamp);
    return failDate >= todayStart && failDate < todayEnd;
  }

  async function challenge2CompleteSuccess(i) {
    await challenge2SaveProgress(i, 'success');
    challenge2ProgressCache = null; // Force reload from database
    await challenge2Render();
  }

  function openChallenge2Fail(i) {
    challenge2FailingDayIndex = i;
    document.getElementById('fail-pushups').value = '';
    document.getElementById('fail-situps').value = '';
    document.getElementById('fail-modal').style.display = 'flex';
  }

  function closeChallenge2Fail() {
    document.getElementById('fail-modal').style.display = 'none';
    challenge2FailingDayIndex = null;
  }

  async function submitChallenge2Fail() {
    if (challenge2FailingDayIndex === null) return;
    
    const pushups = parseInt(document.getElementById('fail-pushups').value) || 0;
    const situps = parseInt(document.getElementById('fail-situps').value) || 0;
    
    await challenge2SaveProgress(challenge2FailingDayIndex, 'failed', { pushups, situps });
    challenge2ProgressCache = null; // Force reload from database
    closeChallenge2Fail();
    await challenge2Render();
  }

  async function challenge2Undo(i) {
    if (currentUser && isFirebaseConfigured) {
      try {
        const completionDoc = doc(db, 'challenge2', `${currentUser.uid}_day-${i}`);
        await deleteDoc(completionDoc);
      } catch (error) {
        console.error('Challenge2 Undo error:', error);
      }
    } else {
      localStorage.removeItem(`challenge2-day-${i}`);
    }
    challenge2ProgressCache = null; // Force reload
    await challenge2Render();
  }

  async function challenge2Render() {
    const list = document.getElementById('challenge2-list');
    const loginRequired = document.getElementById('login-required');
    
    // Check if Firebase is configured and user is logged in
    if (!isFirebaseConfigured || !currentUser) {
      if (list) list.style.display = 'none';
      if (loginRequired) {
        loginRequired.style.display = 'block';
        loginRequired.style.opacity = '1';
      }
      return;
    }
    
    if (list) list.style.display = 'block';
    if (loginRequired) {
      loginRequired.style.display = 'none';
      loginRequired.style.opacity = '0';
    }
    
    const progress = await challenge2GetProgress();
    const hasCompletedToday = challenge2HasCompletedToday(progress);
    
    // Calculate streak (consecutive successful days, rest days don't break it)
    let streak = 0;
    const now = new Date();
    const finlandTime = new Date(now.getTime() + (2 * 60 * 60 * 1000));
    
    // Count backwards from today to find consecutive successful days
    for (let dayOffset = 0; dayOffset <= challenge2Plan.length; dayOffset++) {
      const checkDate = new Date(finlandTime);
      checkDate.setDate(checkDate.getDate() - dayOffset);
      
      // Find if any day was completed with success status on this date
      let foundSuccess = false;
      let foundFailure = false;
      
      for (let i = 0; i < challenge2Plan.length; i++) {
        const dayUsers = progress[`day-${i}`] || {};
        const currentUserData = currentUser ? dayUsers[currentUser.uid] : dayUsers['local'];
        
        if (currentUserData && currentUserData.timestamp) {
          const completionDate = currentUserData.timestamp.toDate ? currentUserData.timestamp.toDate() : new Date(currentUserData.timestamp);
          const completionDay = new Date(completionDate.getTime() + (2 * 60 * 60 * 1000));
          
          if (completionDay.getUTCFullYear() === checkDate.getUTCFullYear() &&
              completionDay.getUTCMonth() === checkDate.getUTCMonth() &&
              completionDay.getUTCDate() === checkDate.getUTCDate()) {
            if (currentUserData.status === 'success') {
              foundSuccess = true;
            } else if (currentUserData.status === 'failed') {
              foundFailure = true;
            }
            break;
          }
        }
      }
      
      if (foundSuccess) {
        streak++;
      } else if (foundFailure) {
        // Failed day breaks the streak
        break;
      }
      // Rest day (no completion) doesn't break streak, continue counting
    }
    
    // Calculate consecutive workout days and rest days since last workout
    let consecutiveDays = 0;
    let restDaysSinceLastWorkout = 0;
    
    // Find the most recent workout and calculate days since
    let lastWorkoutDate = null;
    for (let i = 0; i < challenge2Plan.length; i++) {
      const dayUsers = progress[`day-${i}`] || {};
      const currentUserData = currentUser ? dayUsers[currentUser.uid] : dayUsers['local'];
      
      if (currentUserData && currentUserData.timestamp) {
        const completionDate = currentUserData.timestamp.toDate ? currentUserData.timestamp.toDate() : new Date(currentUserData.timestamp);
        if (!lastWorkoutDate || completionDate > lastWorkoutDate) {
          lastWorkoutDate = completionDate;
        }
      }
    }
    
    // Calculate days since last workout
    if (lastWorkoutDate) {
      const lastWorkoutFinland = new Date(lastWorkoutDate.getTime() + (2 * 60 * 60 * 1000));
      const daysSince = Math.floor((finlandTime - lastWorkoutFinland) / MS_PER_DAY);
      restDaysSinceLastWorkout = daysSince;
      
      // Count consecutive days from that workout backwards
      for (let dayOffset = 1; dayOffset <= 60; dayOffset++) {
        const checkDate = new Date(lastWorkoutFinland);
        checkDate.setDate(checkDate.getDate() - dayOffset);
        
        let foundCompletion = false;
        for (let i = 0; i < challenge2Plan.length; i++) {
          const dayUsers = progress[`day-${i}`] || {};
          const currentUserData = currentUser ? dayUsers[currentUser.uid] : dayUsers['local'];
          
          if (currentUserData && currentUserData.timestamp) {
            const completionDate = currentUserData.timestamp.toDate ? currentUserData.timestamp.toDate() : new Date(currentUserData.timestamp);
            const completionDay = new Date(completionDate.getTime() + (2 * 60 * 60 * 1000));
            
            if (completionDay.getUTCFullYear() === checkDate.getUTCFullYear() &&
                completionDay.getUTCMonth() === checkDate.getUTCMonth() &&
                completionDay.getUTCDate() === checkDate.getUTCDate()) {
              foundCompletion = true;
              break;
            }
          }
        }
        
        if (foundCompletion) {
          consecutiveDays++;
        } else {
          break;
        }
      }
      consecutiveDays++; // Include the last workout day itself
    }
    
    // Find first incomplete or failed day for current user
    let todayIndex = -1;
    for (let i = 0; i < challenge2Plan.length; i++) {
      const dayUsers = progress[`day-${i}`] || {};
      const currentUserData = currentUser ? dayUsers[currentUser.uid] : dayUsers['local'];
      
      if (!currentUserData || currentUserData.status === 'failed') {
        todayIndex = i;
        break;
      }
    }
    
    // If all completed, no "today"
    if (todayIndex === -1) {
      todayIndex = challenge2Plan.length; // Beyond last day
    }
    
    list.innerHTML = "";
    
    // Calculate stats: total pushups and situps (successful + failed)
    let totalPushups = 0;
    let totalSitups = 0;
    let completedDays = 0;
    
    for (let i = 0; i < challenge2Plan.length; i++) {
      const dayUsers = progress[`day-${i}`] || {};
      const currentUserData = currentUser ? dayUsers[currentUser.uid] : dayUsers['local'];
      
      if (currentUserData) {
        if (currentUserData.status === 'success') {
          totalPushups += challenge2Plan[i].p;
          totalSitups += challenge2Plan[i].a;
          completedDays++;
        } else if (currentUserData.status === 'failed') {
          totalPushups += (currentUserData.pushups || 0);
          totalSitups += (currentUserData.situps || 0);
        }
      }
    }
    
    // Calculate estimated calories burned
    // Approximation: pushups ~0.33 kcal each, situps ~0.2 kcal each
    const estimatedCalories = Math.round(totalPushups * 0.33 + totalSitups * 0.2);
    
    // Show stats card
    if (totalPushups > 0 || totalSitups > 0) {
      const statsDiv = document.createElement("div");
      statsDiv.style.cssText = "margin-bottom: 20px; padding: 16px; background: linear-gradient(135deg, #1c2b20 0%, var(--card) 100%); border-radius: 12px; border: 2px solid var(--accent); text-align: center;";
      statsDiv.innerHTML = `
        <div style="font-size: 24px; margin-bottom: 12px;">üìä Haasteen aikana olet tehnyt</div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px;">
          <div style="padding: 10px; background: var(--card-soft); border-radius: 8px;">
            <div style="font-size: 28px; font-weight: bold; color: var(--accent);">${totalPushups}</div>
            <div style="font-size: 12px; color: var(--muted);">Punnerrusta</div>
          </div>
          <div style="padding: 10px; background: var(--card-soft); border-radius: 8px;">
            <div style="font-size: 28px; font-weight: bold; color: var(--accent);">${totalSitups}</div>
            <div style="font-size: 12px; color: var(--muted);">Vatsaa</div>
          </div>
        </div>
    
        <div style="padding: 10px; background: linear-gradient(135deg, #ff6b35 0%, #f7931e 100%); border-radius: 8px; color: #000;">
          <div style="font-size: 20px; font-weight: bold;">üî• ${estimatedCalories} kcal</div>
          <div style="font-size: 12px; opacity: 0.8;">Kaloreita poltettu arviolta</div>
        </div>
      `;
      list.appendChild(statsDiv);
    }
    
    // Show streak if >= 2
    if (streak >= 2) {
      const streakDiv = document.createElement("div");
      streakDiv.style.cssText = "margin-bottom: 20px; padding: 16px; background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%); border-radius: 12px; color: #000; text-align: center; box-shadow: 0 4px 12px rgba(255, 215, 0, 0.3);";
      streakDiv.innerHTML = `
        <div style="font-size: 32px; margin-bottom: 8px;">üî•</div>
        <div style="font-weight: bold; font-size: 20px; margin-bottom: 4px;">${streak} p√§iv√§n putki!</div>
        <div style="font-size: 14px; opacity: 0.8;">Per√§kk√§isi√§ onnistuneita treenej√§ (lepop√§iv√§t eiv√§t katkaise putkea)</div>
      `;
      list.appendChild(streakDiv);
    }
    
    // Show rest day reminder if 3+ consecutive days without rest
    if (consecutiveDays >= 3 && todayIndex < challenge2Plan.length) {
      const reminder = document.createElement("div");
      reminder.style.cssText = "margin-bottom: 20px; padding: 16px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 12px; color: white; text-align: center;";
      reminder.innerHTML = `
        <div style="font-size: 24px; margin-bottom: 8px;">üò¥</div>
        <div style="font-weight: bold; margin-bottom: 4px;">Olet treenannut ${consecutiveDays} p√§iv√§√§ per√§kk√§in!</div>
        <div style="font-size: 14px; opacity: 0.9;">Muista pit√§√§ v√§lill√§ lepop√§iv√§. Palautuminen on t√§rke√§ osa kehityst√§!</div>
      `;
      list.appendChild(reminder);
    }
    
    // Show motivational push message if 3+ rest days since last workout
    if (restDaysSinceLastWorkout > 3 && todayIndex < challenge2Plan.length) {
      const pushDiv = document.createElement("div");
      pushDiv.style.cssText = "margin-bottom: 20px; padding: 16px; background: linear-gradient(135deg, #ff6b6b 0%, #ff8787 100%); border-radius: 12px; color: white; text-align: center;";
      pushDiv.innerHTML = `
        <div style="font-size: 24px; margin-bottom: 8px;">üí™</div>
        <div style="font-weight: bold; margin-bottom: 4px;">Hei, miss√§ sin√§ olet?</div>
        <div style="font-size: 14px; opacity: 0.9;">Olet jo lev√§nnyt ${restDaysSinceLastWorkout} p√§iv√§n ajan. On aika palata haasteen pariin! Joka askeleella p√§√§set l√§hemm√§s tavoitettasi!</div>
      `;
      list.appendChild(pushDiv);
    }
    
    let currentWeek = 0;

    challenge2Plan.forEach((day, i) => {
      const week = challenge2WeekForDay(i);
      if (week !== currentWeek) {
        currentWeek = week;
        const h = document.createElement("h3");
        h.textContent = `Viikko ${week}`;
        h.style.color = 'var(--accent)';
        h.style.fontSize = '16px';
        h.style.margin = '20px 0 12px';
        list.appendChild(h);
      }

      const div = document.createElement("div");
      div.className = "day";

      const dayUsers = progress[`day-${i}`] || {};
      const userCount = Object.keys(dayUsers).length;
      const isToday = i === todayIndex;
      const isFuture = i > todayIndex;
      const currentUserData = currentUser ? dayUsers[currentUser.uid] : dayUsers['local'];

      if (isToday) div.classList.add("today");
      if (isFuture) div.classList.add("future");
      if (userCount > 0) div.classList.add("done");

      let badge = "";
      let status = "Suorittamatta";

      if (currentUserData) {
        if (currentUserData.status === 'success') {
          div.classList.add("completed");
          badge = `<span class="badge completed">SUORITETTU</span>`;
          status = "‚úÖ Suoritettu";
        } else if (currentUserData.status === 'failed') {
          div.classList.add("failed");
          badge = `<span class="badge failed">EP√ÑONNISTUI</span>`;
          status = `‚ö†Ô∏è Ep√§onnistui (${currentUserData.pushups} punnerrusta  + ${currentUserData.situps} vatsaa)`;
        }
      } else if (isToday && hasCompletedToday) {
        badge = `<span class="badge">HUOMENNA</span>`;
      } else if (isToday) {
        badge = `<span class="badge today">T√ÑN√Ñ√ÑN</span>`;
      } else if (userCount > 0) {
        badge = `<span class="badge">SUORITTAJAT (${userCount})</span>`;
      } else {
        badge = `<span class="badge">P√§iv√§ ${i + 1}</span>`;
      }

      let html = `
        <div class="day-header">
          <div>P√§iv√§ ${i + 1}</div>
          ${badge}
        </div>
        <div class="exercise">Punnerrukset: <strong>${day.p}</strong></div>
        <div class="exercise">Vatsat: <strong>${day.a}</strong></div>

      `;

      // Show all users' results
      if (userCount > 0) {
        html += `<div style="margin-top: 12px; padding: 10px; background: var(--card-soft); border-radius: 8px; font-size: 14px;">`;
        html += `<div style="font-weight: bold; margin-bottom: 6px; color: var(--accent);">Suorittajat:</div>`;
        Object.values(dayUsers).forEach(user => {
          const userName = getStoredNameFirstName(user.name);
          if (user.status === 'success') {
            html += `<div style="margin: 4px 0;">‚úÖ ${userName}</div>`;
          } else if (user.status === 'failed') {
            html += `<div style="margin: 4px 0;">‚ö†Ô∏è ${userName} (${user.pushups} punnerrusta ja ${user.situps} vatsaa)</div>`;
          }
        });
        html += `</div>`;
      }

      // Check if this day was completed today (for undo button)
      const isCompletedToday = currentUserData && currentUserData.timestamp && (() => {
        const now = new Date();
        const finlandTime = new Date(now.getTime() + (2 * 60 * 60 * 1000));
        const todayStart = new Date(Date.UTC(finlandTime.getUTCFullYear(), finlandTime.getUTCMonth(), finlandTime.getUTCDate()) - (2 * 60 * 60 * 1000));
        const todayEnd = new Date(todayStart.getTime() + MS_PER_DAY);
        const completionDate = currentUserData.timestamp.toDate ? currentUserData.timestamp.toDate() : new Date(currentUserData.timestamp);
        return completionDate >= todayStart && completionDate < todayEnd;
      })();

      // Show buttons only if it's today's task and no completion today
      if (isToday && !hasCompletedToday) {
        if (!currentUserData) {
          html += `<div class="actions">
            <button class="success-btn" onclick="challenge2CompleteSuccess(${i})">‚úÖ Suorita!</button>
            <button class="fail-btn" onclick="openChallenge2Fail(${i})">‚ùå Ep√§onnistui</button>
          </div>`;
        } else if (currentUserData.status === 'failed') {
          const isFailedToday = challenge2IsFailedToday(i, progress);
          if (isFailedToday) {
            html += `<div class="actions">
              <button class="fail-btn" onclick="openChallenge2Fail(${i})">Muokkaa tuloksia</button>
              <button class="undo-btn" onclick="challenge2Undo(${i})">Kumoa</button>
            </div>`;
          } else {
            html += `<div style="margin-top: 8px; color: var(--accent); font-weight: bold;">üîÑ Yrit√§ uudelleen</div>`;
            html += `<div class="actions">
              <button class="success-btn" onclick="challenge2CompleteSuccess(${i})">‚úÖ Suorita!</button>
              <button class="fail-btn" onclick="openChallenge2Fail(${i})">‚ùå Ep√§onnistui</button>
            </div>`;
          }
        }
      } else if (isToday && hasCompletedToday) {
        // Check if the completion was a failure
        if (currentUserData && currentUserData.status === 'failed') {
          html += `<div class="actions">
            <button class="fail-btn" onclick="openChallenge2Fail(${i})">Muokkaa tuloksia</button>
            <button class="undo-btn" onclick="challenge2Undo(${i})">Kumoa</button>
          </div>`;
        } else {
          html += `<div style="margin-top: 12px; padding: 10px; background: var(--card-soft); border-radius: 8px; color: var(--muted); font-size: 14px;">
            ‚è∏Ô∏è Olet jo tehnyt suorituksen t√§n√§√§n. Voit jatkaa haastetta huomenna!
          </div>`;
        }
      } else if (!isToday && !isFuture && currentUserData) {
        // Show undo button for any day that has been completed or failed
        if (isCompletedToday || currentUserData.status === 'failed') {
          html += `<div class="actions">
            <button class="undo-btn" onclick="challenge2Undo(${i})">Kumoa</button>
          </div>`;
        }
      } else if (isFuture) {
        html += `<div style="margin-top: 12px; padding: 10px; background: var(--card-soft); border-radius: 8px; color: var(--muted); font-size: 14px;">
          üîí Suorita ensin aikaisemmat p√§iv√§t
        </div>`;
      }

      // Add user stamps (only when logged in and for successful completions in challenge2)
      if (currentUser && userCount > 0) {
        const successfulUsers = Object.values(dayUsers).filter(user => user.status === 'success');
        if (successfulUsers.length > 0) {
          html += `<div class="user-stamps">`;
          const positions = [
            { top: '30%', left: '25%' },
            { top: '40%', right: '30%' },
            { top: '50%', right: '15%' },
            { top: '25%', right: '25%' },
            { bottom: '30%', right: '20%' },
            { top: '35%', left: '30%' }
          ];
          
          // Sekoita positiot p√§iv√§kohtaisesti
          const dayRandom = new Array(positions.length).fill().map((_, idx) => idx);
          for (let j = dayRandom.length - 1; j > 0; j--) {
            const k = Math.floor(((i + 1) * 9301 + 49297) % 233280) % (j + 1);
            [dayRandom[j], dayRandom[k]] = [dayRandom[k], dayRandom[j]];
          }
          
          successfulUsers.forEach((user, index) => {
            const pos = positions[dayRandom[index % positions.length]];
            const rotation = Math.floor(((i + index) * 7919 + 31337) % 21) - 10;
            const style = Object.entries(pos).map(([key, value]) => `${key}: ${value}`).join('; ') + `; transform: rotate(${rotation}deg)`;
            html += `<div class="user-stamp" style="${style}; background-image: url(${user.avatar || user.userAvatar})"></div>`;
          });
          html += `</div>`;
        }
      }

      div.innerHTML = html;
      list.appendChild(div);
    });
  }

  // Global functions for challenge 2
  window.challenge2CompleteSuccess = challenge2CompleteSuccess;
  window.openChallenge2Fail = openChallenge2Fail;
  window.closeChallenge2Fail = closeChallenge2Fail;
  window.submitChallenge2Fail = submitChallenge2Fail;
  window.challenge2Undo = challenge2Undo;

  // Render challenge 2 on init
  challenge2Render();

  // Tab navigation
  document.querySelectorAll('.nav-tab').forEach(tab => {
    tab.addEventListener('click', () => {
      const tabName = tab.getAttribute('data-tab');
      
      // Update active tab
      document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
      tab.classList.add('active');
      
      // Update active content
      document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
      document.getElementById(tabName).classList.add('active');
    });
  });
</script>

</body>
</html>
