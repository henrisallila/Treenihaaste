<!DOCTYPE html>
<html lang="fi">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Treenihaaste</title>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
body {
  margin: 0;
  font-family: system-ui, sans-serif;
  background: #0f0f0f;
  color: #f5f5f5;
}
.container {
  max-width: 720px;
  margin: auto;
  padding: 16px;
}
h1 {
  text-align: center;
}
.card {
  background: #1c1c1c;
  border-radius: 12px;
  padding: 16px;
  margin-bottom: 12px;
}
button {
  background: #4caf50;
  color: black;
  border: none;
  border-radius: 8px;
  padding: 10px 14px;
  font-weight: bold;
  cursor: pointer;
  margin-right: 8px;
}
button.delete {
  background: #e53935;
  color: white;
}
button:disabled {
  opacity: 0.4;
  cursor: not-allowed;
}
.small {
  font-size: 0.85em;
  color: #aaa;
}
input[type="text"] {
  width: 100%;
  padding: 10px;
  border-radius: 8px;
  border: none;
  margin-bottom: 8px;
}
.users {
  font-size: 0.9em;
  color: #90caf9;
}
</style>
</head>

<body>
<div class="container">
  <h1>üí™ 21 p√§iv√§n treenihaaste</h1>

  <div class="card">
    <input type="text" id="nickname" placeholder="Nimimerkki (valinnainen)">
    <button onclick="saveNickname()">Tallenna nimimerkki</button>
    <p class="small">
      Jos annat nimimerkkisi, se n√§kyy my√∂s muille sovelluksen k√§ytt√§jille.<br>
      Voit my√∂s pysy√§ anonyymin√§, jolloin suorituksiasi ei jaeta.
    </p>
  </div>

  <div id="days"></div>
</div>

<script>
/* üî• FIREBASE CONFIG */
const firebaseConfig = {
  apiKey: "AIzaSyCTXfIiaTS1H3nFTZSWbGvx0kcOf3Lmwek",
  authDomain: "treenihaaste-15c92.firebaseapp.com",
  databaseURL: "https://treenihaaste-15c92-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "treenihaaste-15c92",
  storageBucket: "treenihaaste-15c92.firebasestorage.app",
  messagingSenderId: "1031392742682",
  appId: "1:1031392742682:web:7ca6953bc40c24285370a3"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.database();

auth.signInAnonymously();

/* üìÖ HAASTE */
const startDate = new Date("2026-01-08");
const challenge = [
  { p: 5, v: 10 }, { p: 6, v: 12 }, { rest: true },
  { p: 7, v: 14 }, { p: 8, v: 16 }, { rest: true },
  { p: 9, v: 18 }, { p: 10, v: 20 }, { rest: true },
  { p: 11, v: 22 }, { p: 12, v: 24 }, { rest: true },
  { p: 13, v: 26 }, { p: 14, v: 28 }, { rest: true },
  { p: 15, v: 30 }, { p: 16, v: 32 }, { rest: true },
  { p: 17, v: 34 }, { p: 18, v: 36 }
];

function saveNickname() {
  const n = document.getElementById("nickname").value.trim();
  localStorage.setItem("nickname", n);
  alert("Tallennettu!");
}

function render() {
  const today = new Date();
  today.setHours(0,0,0,0);
  const container = document.getElementById("days");
  container.innerHTML = "";

  challenge.forEach((day, i) => {
    const date = new Date(startDate);
    date.setDate(startDate.getDate() + i);
    const diff = (date - today) / 86400000;

    const done = localStorage.getItem("done-" + i);
    const card = document.createElement("div");
    card.className = "card";

    let title = `P√§iv√§ ${i+1} ‚Äì ${date.toLocaleDateString("fi-FI")}`;
    let content = "";

    if (day.rest) {
      content = "üõå Lepop√§iv√§";
    } else {
      content = `Punnerrukset: ${day.p}<br>Vatsat: ${day.v}`;
    }

    card.innerHTML = `<strong>${title}</strong><br>${content}<br><br>`;

    if (diff === 0 && !day.rest) {
      if (!done) {
        const btn = document.createElement("button");
        btn.textContent = "SUORITA!";
        btn.onclick = () => completeDay(i);
        card.appendChild(btn);
      } else {
        card.innerHTML += "‚úÖ Suoritettu<br>";
        const del = document.createElement("button");
        del.textContent = "Poista suoritus";
        del.className = "delete";
        del.onclick = () => undoDay(i);
        card.appendChild(del);
      }
    }

    const usersDiv = document.createElement("div");
    usersDiv.className = "users";
    db.ref("completions/" + date.toISOString().slice(0,10))
      .on("value", snap => {
        const data = snap.val();
        if (data) {
          usersDiv.innerHTML = "T√§n√§√§n suorittaneet: " +
            Object.values(data).map(x => x.nickname).join(", ");
        }
      });

    card.appendChild(usersDiv);
    container.appendChild(card);
  });
}

function completeDay(i) {
  localStorage.setItem("done-" + i, "true");
  const nickname = localStorage.getItem("nickname");
  if (nickname) {
    const date = new Date(startDate);
    date.setDate(startDate.getDate() + i);
    auth.onAuthStateChanged(user => {
      if (user) {
        db.ref("completions/" + date.toISOString().slice(0,10) + "/" + user.uid)
          .set({ nickname });
      }
    });
  }
  render();
}

function undoDay(i) {
  localStorage.removeItem("done-" + i);
  auth.onAuthStateChanged(user => {
    if (user) {
      const date = new Date(startDate);
      date.setDate(startDate.getDate() + i);
      db.ref("completions/" + date.toISOString().slice(0,10) + "/" + user.uid)
        .remove();
    }
  });
  render();
}

render();
</script>
</body>
</html>
